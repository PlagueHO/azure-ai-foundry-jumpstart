"{\n  \"sop_id\": \"fbf09be9-bf93-4940-b61f-922794210a8a\",\n  \"version\": \"1.3\",\n  \"created_at\": \"2025-11-28T02:33:24.969629+00:00\",\n  \"last_updated\": \"2025-11-28T03:00:00+00:00\",\n  \"title\": \"Recover and repair Azure Virtual Machine that fails to boot after agent/extension update\",\n  \"problem_category\": \"cloud\",\n  \"complexity\": \"medium\",\n  \"system_context\": \"Azure Virtual Machines\",\n  \"severity\": \"low\",\n  \"status\": \"archived\",\n  \"approval_level\": \"cto\",\n  \"author\": {\n    \"name\": \"Jordan Hale\",\n    \"email\": \"jordan.hale.ops@example-corp.internal\"\n  },\n  \"approver\": {\n    \"name\": \"Rina Patel\",\n    \"email\": \"rina.patel.cto-approvals@example-corp.internal\",\n    \"approved_at\": \"2025-11-28T02:50:00+00:00\"\n  },\n  \"problem_description\": \"After a scheduled or automatic update to the Azure VM Agent or an installed VM extension (e.g., custom script, monitoring agent), the virtual machine fails to complete the boot process. Symptoms include the VM showing 'running' in the portal but no network connectivity, inability to SSH/RDP, serial console showing kernel panic or stalled init, and Azure Run Command failing due to agent unresponsive. This SOP describes steps to diagnose, recover, and repair the VM while preserving data and minimizing downtime.\",\n  \"symptoms\": [\n    \"VM PowerState shows Running but cannot connect via SSH/RDP\",\n    \"Serial console displays kernel panic, systemd hanging, or initrd errors\",\n    \"Azure Run Command (az vm run-command) returns agent not available / 410 status\",\n    \"Boot diagnostics screenshot shows init or fsck errors before login prompt\",\n    \"Recent VM extension operations show failed or in-progress in the portal\"\n  ],\n  \"prerequisites\": [\n    \"Subscription Owner or Contributor on the subscription (or delegated recovery role with disk attach permissions)\",\n    \"Access to the Azure Portal and Azure CLI (az) or Azure PowerShell\",\n    \"Boot diagnostics enabled for the affected VM (recommended) or serial console enabled\",\n    \"A separate rescue VM in the same region and subscription for disk attach operations\",\n    \"Snapshot or backup policy confirmation (ensure recent backups exist before disk operations)\"\n  ],\n  \"required_tools\": [\n    \"Azure CLI (az) v2.XX or newer configured to the target subscription\",\n    \"Azure Portal access\",\n    \"SSH client or RDP client\",\n    \"Access to the cloud provider's serial console (Azure Serial Console)\",\n    \"Local ticketing system to attach logs/screenshots\"\n  ],\n  \"estimated_resolution_time\": \"30-45 minutes\",\n  \"resolution_steps\": [\n    {\n      \"step_number\": 1,\n      \"action\": \"Confirm VM state and recent extension activity\",\n      \"details\": \"In Azure Portal, open the VM resource. Verify Power state (Running/Stopped). Inspect 'Extensions + applications' for recent failures. Using Azure CLI: az vm get-instance-view --resource-group <RG> --name <VMNAME> --query instanceView to get extension and agent status and bootDiagnostics settings.\",\n      \"warnings\": \"\"\n    },\n    {\n      \"step_number\": 2,\n      \"action\": \"Capture boot diagnostics and serial console output\",\n      \"details\": \"If boot diagnostics is enabled, download the screenshot and the serial log from the portal. Open the Serial Console (in portal) to view live kernel output. Note timestamps, kernel panic messages, filesystem errors, or systemd units failing to start. Save console output to the incident.\",\n      \"warnings\": \"\"\n    },\n    {\n      \"step_number\": 3,\n      \"action\": \"Attempt in-place non-invasive recovery (Run Command)\",\n      \"details\": \"Try az vm run-command invoke --command-id RunShellScript --name <VMNAME> --resource-group <RG> --scripts 'echo \"probe\" > /tmp/agent_probe' to test if the agent responds. If successful, fetch /var/log/waagent.log or /var/log/azure/* to investigate extension failures. If agent responds, restart failed services or uninstall problematic extension: az vm extension delete --resource-group <RG> --vm-name <VMNAME> --name <ExtensionName>\",\n      \"warnings\": \"Do not delete critical platform agent extensions unless instructed by platform team.\"\n    },\n    {\n      \"step_number\": 4,\n      \"action\": \"If Run Command / agent is unresponsive, prepare for disk-level recovery\",\n      \"details\": \"Create snapshot of the OS disk: az disk create --resource-group <RG> --name <VMNAME>-osdisk-snap --source /subscriptions/<sub>/resourceGroups/<RG>/providers/Microsoft.Compute/disks/<OSDiskName>. Provision a temporary rescue VM (Linux for Linux VMs, Windows for Windows VMs) in same availability zone/region.\",\n      \"warnings\": \"Creating a snapshot is mandatory before any disk attach/modify operations to preserve data.\"\n    },\n    {\n      \"step_number\": 5,\n      \"action\": \"Detach OS disk and attach to rescue VM as a data disk\",\n      \"details\": \"Stop the target VM (az vm deallocate --resource-group <RG> --name <VMNAME>). Detach OS disk in portal or via az vm update. Attach the disk to the rescue VM: az vm disk attach --resource-group <RG> --vm-name <RESCUE_VM> --disk <OSDiskName> --new --name <attached_disk_name> (or attach the snapshot as a managed disk).\",\n      \"warnings\": \"Do not attach the original OS disk to multiple VMs in read-write mode simultaneously.\"\n    },\n    {\n      \"step_number\": 6,\n      \"action\": \"Mount disk on rescue VM and inspect files\",\n      \"details\": \"SSH/RDP to rescue VM. On Linux: identify device (lsblk), create mount point (mkdir /mnt/recover), mount disk partition (mount /dev/sdc1 /mnt/recover). Inspect /mnt/recover/var/log, /mnt/recover/etc/fstab, /mnt/recover/boot/grub/grub.cfg, and /mnt/recover/var/lib/waagent for broken packages or corrupted config files. For Windows: use Disk Management and chkdsk offline; inspect Event logs under Windows\\\\System32\\\\winevt\\\\Logs.\",\n      \"warnings\": \"Use read-only mounts initially for forensic checks: mount -o ro.\"\n    },\n    {\n      \"step_number\": 7,\n      \"action\": \"Repair common issues (examples)\",\n      \"details\": \"Linux: If fstab has bad UUIDs, update to correct ones from lsblk -f. If initramfs or grub corrupt, chroot into /mnt/recover, run update-initramfs -u and grub-install /dev/sdc. For agent-related issues, remove or rename problematic extension config under /var/lib/waagent/ and ensure cloud-init scripts are not stuck. Windows: restore registry hive or remove problematic driver/service under System32\\\\Drivers if identified.\",\n      \"warnings\": \"Chroot and package operations can change system state \u2014 proceed only after snapshot.\"\n    },\n    {\n      \"step_number\": 8,\n      \"action\": \"Detach repaired disk and reattach as OS disk to original VM\",\n      \"details\": \"On rescue VM, unmount and detach disk (umount /mnt/recover). In Azure, detach disk from rescue VM and reattach to original VM as OS disk, or create a new managed disk from the repaired snapshot and set as VM OS disk (az vm update --resource-group <RG> --name <VMNAME> --os-disk /subscriptions/.../resourceGroups/.../providers/Microsoft.Compute/disks/<disk>).\",\n      \"warnings\": \"Ensure VM is deallocated before swapping OS disk to avoid corruption.\"\n    },\n    {\n      \"step_number\": 9,\n      \"action\": \"Boot the original VM and validate\",\n      \"details\": \"Start the VM (az vm start --resource-group <RG> --name <VMNAME>). Monitor serial console and boot diagnostics. Ensure the Azure VM Agent registers and allows Run Command. Reapply or reinstall necessary extensions using az vm extension set if required.\",\n      \"warnings\": \"\"\n    },\n    {\n      \"step_number\": 10,\n      \"action\": \"Post-recovery actions and clean-up\",\n      \"details\": \"Remove temporary rescue VM and any interim managed disks if not needed. Update incident notes with actions performed, attach snapshots and console logs. If root cause was an extension or agent update, schedule a controlled re-deployment window and notify application owners. If a configuration change was made (fstab, grub), record the change in change control.\",\n      \"warnings\": \"\"\n    }\n  ],\n  \"verification_steps\": [\n    {\n      \"step\": \"Confirm VM boots to login prompt and accepts SSH/RDP connections within expected timeframe.\"\n    },\n    {\n      \"step\": \"Run az vm get-instance-view --resource-group <RG> --name <VMNAME> and verify provisioningState is Succeeded and VM agent status is Ready.\"\n    },\n    {\n      \"step\": \"Execute a benign Run Command (az vm run-command invoke) that returns expected output to confirm agent responsiveness.\"\n    },\n    {\n      \"step\": \"Check application-level health endpoints and monitor metrics for 15-30 minutes to ensure no regressions.\"\n    },\n    {\n      \"step\": \"Confirm backups/snapshots are intact and update ticket with recovery artifacts/locations.\"\n    }\n  ],\n  \"troubleshooting\": [\n    {\n      \"issue\": \"Run Command fails with 'Guest agent not present' but serial console shows system running\",\n      \"solution\": \"Validate the OS-level agent files. For Linux, check /var/lib/waagent and /var/log/waagent.log. If agent binary missing, reinstall the agent from the distribution package repository within the rescue mount and reattach disk. If reinstall not possible, restore from snapshot and engage platform team.\"\n    },\n    {\n      \"issue\": \"Serial console shows 'fsck found errors' and drops to maintenance shell\",\n      \"solution\": \"Mount disk on rescue VM and run fsck -fy on affected partitions. Repair errors, then boot VM. Ensure filesystem UUIDs in /etc/fstab are correct to prevent repeated fsck issues.\"\n    },\n    {\n      \"issue\": \"VM boots but networking not available after agent/extension update\",\n      \"solution\": \"Check udev rules or network interface naming changes in /etc/udev/rules.d and /etc/network/interfaces or netplan. If cloud-init altered interface config, revert to previous stable config. Restart network services and Azure DHCP client if present.\"\n    },\n    {\n      \"issue\": \"Unable to detach OS disk due to lock/operation in progress\",\n      \"solution\": \"Ensure VM is deallocated and no other operations (snapshots, backups) are running. Use az vm get-instance-view to confirm no in-progress operations. If locks exist, consult subscription owner to remove management locks temporarily.\"\n    }\n  ],\n  \"escalation\": {\n    \"condition\": \"If after disk-level recovery and agent reinstall the VM still fails to boot or production data integrity is at risk, or if you cannot create a snapshot due to quota/permission issues.\",\n    \"contact\": \"Azure Platform Team via platform-team@example-corp.internal or Pager: +1-800-555-PLAT (fictional)\",\n    \"escalation_path\": \"1) Notify on-call Platform Engineer with incident ID and attach boot logs. 2) If Platform Engineer cannot resolve within 60 minutes, escalate to Cloud Infra Lead. 3) If further vendor escalation is required, Platform Engineer will open a support case with the cloud vendor and include snapshots and serial console logs.\"\n  },\n  \"related_documentation\": [\n    {\n      \"title\": \"Internal: VM Rescue Playbook (disk attach workflow)\",\n      \"url\": \"https://intranet.example-corp.internal/docs/azure/vm-rescue-playbook\"\n    },\n    {\n      \"title\": \"Internal KB: Handling Azure VM Agent update failures\",\n      \"url\": \"https://kb.example-corp.internal/azure/vm-agent-failure-guidance\"\n    },\n    {\n      \"title\": \"Internal: Snapshot and snapshot policy guidelines\",\n      \"url\": \"https://intranet.example-corp.internal/docs/backup/snapshot-policy\"\n    }\n  ],\n  \"tags\": [\n    \"azure\",\n    \"vm\",\n    \"boot\",\n    \"agent\",\n    \"recovery\",\n    \"disk\",\n    \"operations\"\n  ],\n  \"version_history\": [\n    {\n      \"version\": \"1.0\",\n      \"date\": \"2025-05-12T09:15:00+00:00\",\n      \"author\": \"Jordan Hale\",\n      \"changes\": \"Initial creation of boot-failure recovery SOP for Azure VMs describing Run Command and serial console diagnostics.\"\n    },\n    {\n      \"version\": \"1.1\",\n      \"date\": \"2025-08-03T14:20:00+00:00\",\n      \"author\": \"Jordan Hale\",\n      \"changes\": \"Added disk snapshot step and clearer warnings about snapshot before disk operations.\"\n    },\n    {\n      \"version\": \"1.2\",\n      \"date\": \"2025-10-10T11:05:00+00:00\",\n      \"author\": \"Samantha Li\",\n      \"changes\": \"Expanded troubleshooting section with common fstab and network naming fixes; included verification steps for Run Command.\"\n    },\n    {\n      \"version\": \"1.3\",\n      \"date\": \"2025-11-28T02:33:24.969629+00:00\",\n      \"author\": \"Jordan Hale\",\n      \"changes\": \"Archival update: updated approval metadata, added serial console capture guidance, and tightened escalation windows.\"\n    }\n  ]\n}"